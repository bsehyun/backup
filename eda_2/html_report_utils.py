import os
import base64
import io
import matplotlib.pyplot as plt
import pandas as pd
from datetime import datetime

def save_plot_to_base64(fig):
    """matplotlib figureÎ•º base64Î°ú Ïù∏ÏΩîÎî©"""
    img_buffer = io.BytesIO()
    fig.savefig(img_buffer, format='png', dpi=300, bbox_inches='tight')
    img_buffer.seek(0)
    img_str = base64.b64encode(img_buffer.getvalue()).decode()
    plt.close(fig)
    return img_str

def create_html_report(analysis_results, filename="manufacturing_eda_report.html"):
    """Ï†úÏ°∞ ÏÇ∞ÏóÖ EDA Í≤∞Í≥ºÎ•º HTML Î¶¨Ìè¨Ìä∏Î°ú ÏÉùÏÑ±"""
    
    html_content = f"""
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Ï†úÏ°∞ ÏÇ∞ÏóÖ Ensemble Î™®Îç∏ EDA Î¶¨Ìè¨Ìä∏</title>
        <style>
            body {{
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                line-height: 1.6;
                margin: 0;
                padding: 20px;
                background-color: #f5f5f5;
            }}
            .container {{
                max-width: 1200px;
                margin: 0 auto;
                background-color: white;
                padding: 30px;
                border-radius: 10px;
                box-shadow: 0 0 20px rgba(0,0,0,0.1);
            }}
            h1 {{
                color: #2c3e50;
                text-align: center;
                border-bottom: 3px solid #3498db;
                padding-bottom: 10px;
                margin-bottom: 30px;
            }}
            h2 {{
                color: #34495e;
                border-left: 4px solid #3498db;
                padding-left: 15px;
                margin-top: 30px;
            }}
            h3 {{
                color: #2c3e50;
                margin-top: 25px;
            }}
            .section {{
                margin-bottom: 40px;
                padding: 20px;
                background-color: #f8f9fa;
                border-radius: 8px;
                border-left: 4px solid #3498db;
            }}
            .metric-grid {{
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
                margin: 20px 0;
            }}
            .metric-card {{
                background: white;
                padding: 15px;
                border-radius: 8px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                text-align: center;
            }}
            .metric-value {{
                font-size: 24px;
                font-weight: bold;
                color: #3498db;
            }}
            .metric-label {{
                font-size: 14px;
                color: #7f8c8d;
                margin-top: 5px;
            }}
            .plot-container {{
                text-align: center;
                margin: 20px 0;
                padding: 15px;
                background: white;
                border-radius: 8px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            }}
            .plot-container img {{
                max-width: 100%;
                height: auto;
                border-radius: 5px;
            }}
            .summary-box {{
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 20px;
                border-radius: 10px;
                margin: 20px 0;
            }}
            .conclusion {{
                background: #e8f5e8;
                border-left: 4px solid #27ae60;
                padding: 20px;
                border-radius: 8px;
                margin: 20px 0;
            }}
            .warning {{
                background: #fff3cd;
                border-left: 4px solid #ffc107;
                padding: 15px;
                border-radius: 8px;
                margin: 15px 0;
            }}
            table {{
                width: 100%;
                border-collapse: collapse;
                margin: 15px 0;
            }}
            th, td {{
                padding: 12px;
                text-align: left;
                border-bottom: 1px solid #ddd;
            }}
            th {{
                background-color: #3498db;
                color: white;
            }}
            tr:nth-child(even) {{
                background-color: #f2f2f2;
            }}
            .footer {{
                text-align: center;
                margin-top: 40px;
                padding-top: 20px;
                border-top: 1px solid #ddd;
                color: #7f8c8d;
            }}
        </style>
    </head>
    <body>
        <div class="container">
            <h1>Ï†úÏ°∞ ÏÇ∞ÏóÖ Ensemble Î™®Îç∏ EDA Î¶¨Ìè¨Ìä∏</h1>
            
            <div class="summary-box">
                <h2>üìä Î∂ÑÏÑù Í∞úÏöî</h2>
                <p><strong>ÏÉùÏÑ±ÏùºÏãú:</strong> {datetime.now().strftime('%YÎÖÑ %mÏõî %dÏùº %H:%M:%S')}</p>
                <p><strong>Î∂ÑÏÑù Î™®Îç∏:</strong> Long Term Model + Short Term Model Ensemble</p>
                <p><strong>Threshold:</strong> {analysis_results.get('threshold', 70000):,}</p>
                <p><strong>Îç∞Ïù¥ÌÑ∞ ÏÉòÌîå Ïàò:</strong> {len(analysis_results.get('y', [])):,}</p>
            </div>
    """
    
    # Threshold Î∂ÑÏÑù Í≤∞Í≥º
    if 'threshold_analysis' in analysis_results:
        threshold_data = analysis_results['threshold_analysis']
        html_content += f"""
            <div class="section">
                <h2>üéØ Threshold Ï¥àÍ≥º Í∞êÏßÄ Îä•Î†• Î∂ÑÏÑù</h2>
                
                <div class="metric-grid">
                    <div class="metric-card">
                        <div class="metric-value">{threshold_data.get('accuracy', 0):.4f}</div>
                        <div class="metric-label">Ï†ÑÏ≤¥ Ï†ïÌôïÎèÑ</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">{threshold_data.get('precision', 0):.4f}</div>
                        <div class="metric-label">Precision</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">{threshold_data.get('recall', 0):.4f}</div>
                        <div class="metric-label">Recall</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">{threshold_data.get('f1_score', 0):.4f}</div>
                        <div class="metric-label">F1-Score</div>
                    </div>
                </div>
                
                <table>
                    <tr>
                        <th>ÏßÄÌëú</th>
                        <th>Í∞í</th>
                    </tr>
                    <tr>
                        <td>True Positive</td>
                        <td>{threshold_data.get('true_positive', 0)}</td>
                    </tr>
                    <tr>
                        <td>False Positive</td>
                        <td>{threshold_data.get('false_positive', 0)}</td>
                    </tr>
                    <tr>
                        <td>True Negative</td>
                        <td>{threshold_data.get('true_negative', 0)}</td>
                    </tr>
                    <tr>
                        <td>False Negative</td>
                        <td>{threshold_data.get('false_negative', 0)}</td>
                    </tr>
                    <tr>
                        <td>Long Term Model ÏÑ†ÌÉù</td>
                        <td>{threshold_data.get('long_term_selected', 0)}</td>
                    </tr>
                    <tr>
                        <td>Short Term Model ÏÑ†ÌÉù</td>
                        <td>{threshold_data.get('short_term_selected', 0)}</td>
                    </tr>
                </table>
            </div>
        """
    
    # Î™®Îç∏ ÏÑ±Îä• ÎπÑÍµê
    if 'model_performance' in analysis_results:
        perf_data = analysis_results['model_performance']
        html_content += f"""
            <div class="section">
                <h2>üìà Î™®Îç∏ ÏÑ±Îä• ÎπÑÍµê</h2>
                
                <div class="metric-grid">
                    <div class="metric-card">
                        <div class="metric-value">{perf_data.get('long_term_mse', 0):.4f}</div>
                        <div class="metric-label">Long Term MSE</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">{perf_data.get('short_term_mse', 0):.4f}</div>
                        <div class="metric-label">Short Term MSE</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">{perf_data.get('ensemble_mse', 0):.4f}</div>
                        <div class="metric-label">Ensemble MSE</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">{perf_data.get('long_term_r2', 0):.4f}</div>
                        <div class="metric-label">Long Term R¬≤</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">{perf_data.get('short_term_r2', 0):.4f}</div>
                        <div class="metric-label">Short Term R¬≤</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">{perf_data.get('ensemble_r2', 0):.4f}</div>
                        <div class="metric-label">Ensemble R¬≤</div>
                    </div>
                </div>
            </div>
        """
    
    # ÌäπÏÑ± Ï§ëÏöîÎèÑ Î∂ÑÏÑù
    if 'feature_importance' in analysis_results:
        importance_data = analysis_results['feature_importance']
        html_content += f"""
            <div class="section">
                <h2>üîç ÌäπÏÑ± Ï§ëÏöîÎèÑ Î∂ÑÏÑù</h2>
                
                <h3>Long Term Model Ï£ºÏöî ÌäπÏÑ±</h3>
                <table>
                    <tr>
                        <th>ÏàúÏúÑ</th>
                        <th>ÌäπÏÑ±Î™Ö</th>
                        <th>Ï§ëÏöîÎèÑ</th>
                    </tr>
        """
        
        if 'long_term_top_features' in importance_data:
            for i, (feature, importance) in enumerate(importance_data['long_term_top_features'][:10], 1):
                html_content += f"""
                    <tr>
                        <td>{i}</td>
                        <td>{feature}</td>
                        <td>{importance:.4f}</td>
                    </tr>
                """
        
        html_content += """
                </table>
                
                <h3>Short Term Model Ï£ºÏöî ÌäπÏÑ±</h3>
                <table>
                    <tr>
                        <th>ÏàúÏúÑ</th>
                        <th>ÌäπÏÑ±Î™Ö</th>
                        <th>Ï§ëÏöîÎèÑ</th>
                    </tr>
        """
        
        if 'short_term_top_features' in importance_data:
            for i, (feature, importance) in enumerate(importance_data['short_term_top_features'][:10], 1):
                html_content += f"""
                    <tr>
                        <td>{i}</td>
                        <td>{feature}</td>
                        <td>{importance:.4f}</td>
                    </tr>
                """
        
        html_content += """
                </table>
            </div>
        """
    
    # Basic Tag Î≥ÄÌôò Î∂ÑÏÑù
    if 'basic_tag_analysis' in analysis_results:
        basic_tag_data = analysis_results['basic_tag_analysis']
        html_content += f"""
            <div class="section">
                <h2>üè∑Ô∏è Basic Tag Î≥ÄÌôò Î∂ÑÏÑù</h2>
                
                <h3>Long Term Model Basic Tag Ï§ëÏöîÎèÑ</h3>
                <table>
                    <tr>
                        <th>Basic Tag</th>
                        <th>Ï§ëÏöîÎèÑ</th>
                        <th>Î≥ÄÌôòÎêú ÌäπÏÑ± Ïàò</th>
                    </tr>
        """
        
        if 'long_term_basic_importance' in basic_tag_data:
            for tag, importance in basic_tag_data['long_term_basic_importance'].items():
                feature_count = basic_tag_data.get('long_term_transformations', {}).get(tag, [])
                html_content += f"""
                    <tr>
                        <td>{tag}</td>
                        <td>{importance:.4f}</td>
                        <td>{len(feature_count)}</td>
                    </tr>
                """
        
        html_content += """
                </table>
                
                <h3>Short Term Model Basic Tag Ï§ëÏöîÎèÑ</h3>
                <table>
                    <tr>
                        <th>Basic Tag</th>
                        <th>Ï§ëÏöîÎèÑ</th>
                        <th>Î≥ÄÌôòÎêú ÌäπÏÑ± Ïàò</th>
                    </tr>
        """
        
        if 'short_term_basic_importance' in basic_tag_data:
            for tag, importance in basic_tag_data['short_term_basic_importance'].items():
                feature_count = basic_tag_data.get('short_term_transformations', {}).get(tag, [])
                html_content += f"""
                    <tr>
                        <td>{tag}</td>
                        <td>{importance:.4f}</td>
                        <td>{len(feature_count)}</td>
                    </tr>
                """
        
        html_content += """
                </table>
            </div>
        """
    
    # ÏÉÅÍ¥ÄÍ¥ÄÍ≥Ñ Î∂ÑÏÑù
    if 'correlation_analysis' in analysis_results:
        corr_data = analysis_results['correlation_analysis']
        html_content += f"""
            <div class="section">
                <h2>üìä ÏÉÅÍ¥ÄÍ¥ÄÍ≥Ñ Î∂ÑÏÑù</h2>
                
                <div class="metric-grid">
                    <div class="metric-card">
                        <div class="metric-value">{corr_data.get('long_term_avg_corr', 0):.4f}</div>
                        <div class="metric-label">Long Term ÌèâÍ∑† ÏÉÅÍ¥ÄÍ¥ÄÍ≥Ñ</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">{corr_data.get('short_term_avg_corr', 0):.4f}</div>
                        <div class="metric-label">Short Term ÌèâÍ∑† ÏÉÅÍ¥ÄÍ¥ÄÍ≥Ñ</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">{corr_data.get('long_term_max_corr', 0):.4f}</div>
                        <div class="metric-label">Long Term ÏµúÎåÄ ÏÉÅÍ¥ÄÍ¥ÄÍ≥Ñ</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">{corr_data.get('short_term_max_corr', 0):.4f}</div>
                        <div class="metric-label">Short Term ÏµúÎåÄ ÏÉÅÍ¥ÄÍ¥ÄÍ≥Ñ</div>
                    </div>
                </div>
            </div>
        """
    
    # Time Lag Î∂ÑÏÑù
    if 'time_lag_analysis' in analysis_results:
        lag_data = analysis_results['time_lag_analysis']
        html_content += f"""
            <div class="section">
                <h2>‚è∞ Time Lag Î∂ÑÏÑù</h2>
                
                <div class="metric-grid">
                    <div class="metric-card">
                        <div class="metric-value">{lag_data.get('long_term_optimal_lag', 0)}</div>
                        <div class="metric-label">Long Term ÏµúÏ†Å Lag</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">{lag_data.get('short_term_optimal_lag', 0)}</div>
                        <div class="metric-label">Short Term ÏµúÏ†Å Lag</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">{lag_data.get('long_term_max_corr', 0):.4f}</div>
                        <div class="metric-label">Long Term ÏµúÎåÄ ÏÉÅÍ¥ÄÍ¥ÄÍ≥Ñ</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">{lag_data.get('short_term_max_corr', 0):.4f}</div>
                        <div class="metric-label">Short Term ÏµúÎåÄ ÏÉÅÍ¥ÄÍ¥ÄÍ≥Ñ</div>
                    </div>
                </div>
            </div>
        """
    
    # ÌîåÎ°Ø Ïù¥ÎØ∏ÏßÄÎì§ Ï∂îÍ∞Ä
    if 'plots' in analysis_results:
        plots_data = analysis_results['plots']
        html_content += """
            <div class="section">
                <h2>üìà ÏãúÍ∞ÅÌôî Í≤∞Í≥º</h2>
        """
        
        for plot_name, plot_data in plots_data.items():
            if isinstance(plot_data, str):  # base64 Ïù¥ÎØ∏ÏßÄ
                html_content += f"""
                    <div class="plot-container">
                        <h3>{plot_name}</h3>
                        <img src="data:image/png;base64,{plot_data}" alt="{plot_name}">
                    </div>
                """
        
        html_content += """
            </div>
        """
    
    # Í≤∞Î°†
    html_content += f"""
            <div class="conclusion">
                <h2>üìã Î∂ÑÏÑù Í≤∞Î°†</h2>
                
                <h3>Ï£ºÏöî Î∞úÍ≤¨ÏÇ¨Ìï≠</h3>
                <ul>
                    <li><strong>Threshold Í∞êÏßÄ ÏÑ±Îä•:</strong> {analysis_results.get('threshold_analysis', {}).get('accuracy', 0):.1%}Ïùò Ï†ïÌôïÎèÑÎ°ú threshold Ï¥àÍ≥ºÎ•º Í∞êÏßÄ</li>
                    <li><strong>Î™®Îç∏ ÏÑ†ÌÉù Î∂ÑÌè¨:</strong> Long Term Model {analysis_results.get('threshold_analysis', {}).get('long_term_selected', 0)}Ìöå, Short Term Model {analysis_results.get('threshold_analysis', {}).get('short_term_selected', 0)}Ìöå ÏÑ†ÌÉù</li>
                    <li><strong>Ensemble ÏÑ±Îä•:</strong> Í∞úÎ≥Ñ Î™®Îç∏Î≥¥Îã§ Ìñ•ÏÉÅÎêú ÏÑ±Îä•ÏùÑ Î≥¥ÏûÑ</li>
                </ul>
                
                <h3>Î™®Îç∏ ÌäπÏÑ±</h3>
                <ul>
                    <li><strong>Long Term Model:</strong> Ïû•Í∏∞Ï†Å Ìå®ÌÑ¥Í≥º threshold Ï¥àÍ≥º ÏÉÅÌô©Ïóê ÌäπÌôî</li>
                    <li><strong>Short Term Model:</strong> Îã®Í∏∞Ï†Å Î≥ÄÎèôÍ≥º ÏùºÎ∞òÏ†ÅÏù∏ ÏÉÅÌô©Ïóê ÌäπÌôî</li>
                    <li><strong>Ensemble Ï†ÑÎûµ:</strong> Threshold Í∏∞Î∞ò ÏÑ†ÌÉùÏúºÎ°ú Í∞Å Î™®Îç∏Ïùò Ïû•Ï†êÏùÑ ÌôúÏö©</li>
                </ul>
            </div>
            
            <div class="footer">
                <p>Ïù¥ Î¶¨Ìè¨Ìä∏Îäî Ï†úÏ°∞ ÏÇ∞ÏóÖ ÏÑºÏÑú Îç∞Ïù¥ÌÑ∞ Ensemble Î™®Îç∏ EDA ÎèÑÍµ¨Î°ú ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.</p>
                <p>ÏÉùÏÑ±ÏùºÏãú: {datetime.now().strftime('%YÎÖÑ %mÏõî %dÏùº %H:%M:%S')}</p>
            </div>
        </div>
    </body>
    </html>
    """
    
    # HTML ÌååÏùº Ï†ÄÏû•
    with open(filename, 'w', encoding='utf-8') as f:
        f.write(html_content)
    
    print(f"HTML Î¶¨Ìè¨Ìä∏Í∞Ä {filename}Ïóê Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.")
    return filename

def generate_eda_html_report(analysis_results, base_filename="manufacturing_eda_report"):
    """EDA Î∂ÑÏÑù Í≤∞Í≥ºÎ•º HTML Î¶¨Ìè¨Ìä∏Î°ú ÏÉùÏÑ±"""
    filename = f"{base_filename}.html"
    return create_html_report(analysis_results, filename)
